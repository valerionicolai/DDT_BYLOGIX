<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Material Types API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .auth-section {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .auth-section h2 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
        }

        .stats-section {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .stats-section h2 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-row > * {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .auth-section label,
        .stats-section label {
            color: white;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        button.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        button.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .response {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        .response.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .response.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .material-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .material-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .material-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .material-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }

        .material-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .material-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }

        .detail-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2c3e50;
            font-weight: 500;
        }

        .material-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .material-actions button {
            padding: 8px 15px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .properties-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .property-item:last-child {
            border-bottom: none;
        }

        .property-key {
            font-weight: 600;
            color: #6c757d;
        }

        .property-value {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß± Material Types API Test</h1>
            <p>Test completo delle API RESTful per la gestione dei tipi di materiale</p>
        </div>

        <div class="content">
            <!-- Sezione Autenticazione -->
            <div class="section auth-section">
                <h2>üîê Autenticazione</h2>
                <div class="form-row">
                    <div>
                        <label for="email">Email:</label>
                        <input type="email" id="email" value="admin@example.com">
                    </div>
                    <div>
                        <label for="password">Password:</label>
                        <input type="password" id="password" value="password">
                    </div>
                </div>
                <button onclick="login()">üîë Login</button>
                <button onclick="logout()" class="danger">üö™ Logout</button>
                <div id="authResponse" class="response hidden"></div>
            </div>

            <!-- Sezione Statistiche -->
            <div class="section stats-section">
                <h2>üìä Statistiche Material Types</h2>
                <button onclick="getStats()" class="success">üìà Carica Statistiche</button>
                <button onclick="getCategories()" class="warning">üè∑Ô∏è Carica Categorie</button>
                <button onclick="getUnitsOfMeasure()" class="warning">üìè Carica Unit√† di Misura</button>
                <div id="statsContainer" class="stats-grid hidden"></div>
                <div id="statsResponse" class="response hidden"></div>
            </div>

            <!-- Sezione Lista Material Types -->
            <div class="section">
                <h2>üìã Lista Material Types</h2>
                
                <!-- Filtri -->
                <div class="filters">
                    <div>
                        <label for="filterStatus">Status:</label>
                        <select id="filterStatus">
                            <option value="">Tutti</option>
                            <option value="active">Attivo</option>
                            <option value="inactive">Inattivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterCategory">Categoria:</label>
                        <select id="filterCategory">
                            <option value="">Tutte</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterUnit">Unit√† di Misura:</label>
                        <select id="filterUnit">
                            <option value="">Tutte</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchTerm">Ricerca:</label>
                        <input type="text" id="searchTerm" placeholder="Nome, descrizione, categoria...">
                    </div>
                    <div>
                        <label for="minPrice">Prezzo Min (‚Ç¨):</label>
                        <input type="number" id="minPrice" step="0.01" min="0">
                    </div>
                    <div>
                        <label for="maxPrice">Prezzo Max (‚Ç¨):</label>
                        <input type="number" id="maxPrice" step="0.01" min="0">
                    </div>
                    <div>
                        <label for="sortBy">Ordina per:</label>
                        <select id="sortBy">
                            <option value="created_at">Data Creazione</option>
                            <option value="name">Nome</option>
                            <option value="category">Categoria</option>
                            <option value="default_price">Prezzo</option>
                            <option value="status">Status</option>
                        </select>
                    </div>
                    <div>
                        <label for="sortDirection">Direzione:</label>
                        <select id="sortDirection">
                            <option value="desc">Decrescente</option>
                            <option value="asc">Crescente</option>
                        </select>
                    </div>
                    <div>
                        <label for="perPage">Per Pagina:</label>
                        <select id="perPage">
                            <option value="10">10</option>
                            <option value="15" selected>15</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>

                <button onclick="getMaterialTypes()">üìã Carica Material Types</button>
                <button onclick="clearFilters()" class="warning">üßπ Pulisci Filtri</button>
                
                <div id="materialTypesContainer"></div>
                <div id="listResponse" class="response hidden"></div>
            </div>

            <!-- Sezione Creazione/Modifica Material Type -->
            <div class="section">
                <h2 id="formTitle">‚ûï Crea Nuovo Material Type</h2>
                
                <form id="materialTypeForm">
                    <input type="hidden" id="materialTypeId">
                    
                    <div class="form-row">
                        <div>
                            <label for="name">Nome *:</label>
                            <input type="text" id="name" required>
                        </div>
                        <div>
                            <label for="category">Categoria:</label>
                            <input type="text" id="category">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Descrizione:</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="unitOfMeasure">Unit√† di Misura *:</label>
                            <input type="text" id="unitOfMeasure" required placeholder="es: kg, m¬≤, pz, ton">
                        </div>
                        <div>
                            <label for="defaultPrice">Prezzo Default (‚Ç¨):</label>
                            <input type="number" id="defaultPrice" step="0.01" min="0">
                        </div>
                        <div>
                            <label for="status">Status:</label>
                            <select id="status">
                                <option value="active">Attivo</option>
                                <option value="inactive">Inattivo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="properties">Propriet√† (JSON):</label>
                        <textarea id="properties" rows="4" placeholder='{"densit√†": "750 kg/m¬≥", "durezza": "Alta"}'></textarea>
                        <small style="color: #6c757d;">Inserire un oggetto JSON valido con le propriet√† del materiale</small>
                    </div>

                    <button type="button" onclick="saveMaterialType()" class="success">üíæ Salva Material Type</button>
                    <button type="button" onclick="resetForm()" class="warning">üîÑ Reset Form</button>
                </form>

                <div id="formResponse" class="response hidden"></div>
            </div>

            <!-- Sezione Visualizza Material Type -->
            <div class="section">
                <h2>üëÅÔ∏è Visualizza Material Type</h2>
                <div class="form-row">
                    <div>
                        <label for="viewId">ID Material Type:</label>
                        <input type="number" id="viewId" min="1">
                    </div>
                </div>
                <button onclick="viewMaterialType()">üëÅÔ∏è Visualizza</button>
                <div id="viewResponse" class="response hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let authToken = localStorage.getItem('authToken');
        let currentPage = 1;

        // Funzioni di utilit√†
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.classList.remove('hidden');
        }

        function hideResponse(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function getAuthHeaders() {
            return authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
        }

        // Autenticazione
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success && data.token) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showResponse('authResponse', { message: 'Login effettuato con successo!', user: data.user });
                } else {
                    showResponse('authResponse', data, true);
                }
            } catch (error) {
                showResponse('authResponse', { error: error.message }, true);
            }
        }

        async function logout() {
            if (!authToken) {
                showResponse('authResponse', { message: 'Non sei autenticato' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });

                const data = await response.json();
                authToken = null;
                localStorage.removeItem('authToken');
                showResponse('authResponse', { message: 'Logout effettuato con successo!' });
            } catch (error) {
                showResponse('authResponse', { error: error.message }, true);
            }
        }

        // Statistiche
        async function getStats() {
            if (!authToken) {
                showResponse('statsResponse', { error: 'Devi essere autenticato' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/material-types/stats`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    displayStats(data.data);
                    showResponse('statsResponse', data);
                } else {
                    showResponse('statsResponse', data, true);
                }
            } catch (error) {
                showResponse('statsResponse', { error: error.message }, true);
            }
        }

        function displayStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.active}</div>
                    <div class="stat-label">Attivi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.inactive}</div>
                    <div class="stat-label">Inattivi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.with_price}</div>
                    <div class="stat-label">Con Prezzo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.without_price}</div>
                    <div class="stat-label">Senza Prezzo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">‚Ç¨${stats.average_price ? parseFloat(stats.average_price).toFixed(2) : '0.00'}</div>
                    <div class="stat-label">Prezzo Medio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.recent}</div>
                    <div class="stat-label">Recenti (30gg)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.by_category || {}).length}</div>
                    <div class="stat-label">Categorie</div>
                </div>
            `;
            container.classList.remove('hidden');
        }

        async function getCategories() {
            if (!authToken) {
                showResponse('statsResponse', { error: 'Devi essere autenticato' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/material-types/categories`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    populateSelect('filterCategory', data.data);
                    showResponse('statsResponse', data);
                } else {
                    showResponse('statsResponse', data, true);
                }
            } catch (error) {
                showResponse('statsResponse', { error: error.message }, true);
            }
        }

        async function getUnitsOfMeasure() {
            if (!authToken) {
                showResponse('statsResponse', { error: 'Devi essere autenticato' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/material-types/units-of-measure`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    populateSelect('filterUnit', data.data);
                    showResponse('statsResponse', data);
                } else {
                    showResponse('statsResponse', data, true);
                }
            } catch (error) {
                showResponse('statsResponse', { error: error.message }, true);
            }
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Mantieni la prima opzione (Tutti/Tutte)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            select.value = currentValue;
        }

        // Lista Material Types
        async function getMaterialTypes(page = 1) {
            if (!authToken) {
                showResponse('listResponse', { error: 'Devi essere autenticato' }, true);
                return;
            }

            const params = new URLSearchParams();
            
            // Filtri
            const status = document.getElementById('filterStatus').value;
            const category = document.getElementById('filterCategory').value;
            const unit = document.getElementById('filterUnit').value;
            const search = document.getElementById('searchTerm').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            const sortBy = document.getElementById('sortBy').value;
            const sortDirection = document.getElementById('sortDirection').value;
            const perPage = document.getElementById('perPage').value;

            if (status) params.append('status', status);
            if (category) params.append('category', category);
            if (unit) params.append('unit_of_measure', unit);
            if (search) params.append('search', search);
            if (minPrice) params.append('min_price', minPrice);
            if (maxPrice) params.append('max_price', maxPrice);
            if (sortBy) params.append('sort_by', sortBy);
            if (sortDirection) params.append('sort_direction', sortDirection);
            if (perPage) params.append('per_page', perPage);
            if (page > 1) params.append('page', page);

            try {
                const response = await fetch(`${API_BASE}/material-types?${params}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    displayMaterialTypes(data.data, data.pagination);
                    currentPage = data.pagination.current_page;
                    showResponse('listResponse', data);
                } else {
                    showResponse('listResponse', data, true);
                }
            } catch (error) {
                showResponse('listResponse', { error: error.message }, true);
            }
        }

        function displayMaterialTypes(materialTypes, pagination) {
            const container = document.getElementById('materialTypesContainer');
            
            if (!materialTypes || materialTypes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">Nessun material type trovato</p>';
                return;
            }

            let html = '';
            
            materialTypes.forEach(material => {
                const statusClass = material.status === 'active' ? 'status-active' : 'status-inactive';
                const price = material.default_price ? `‚Ç¨${parseFloat(material.default_price).toFixed(2)}` : 'N/D';
                
                let propertiesHtml = '';
                if (material.properties && typeof material.properties === 'object') {
                    propertiesHtml = '<div class="properties-list">';
                    Object.entries(material.properties).forEach(([key, value]) => {
                        propertiesHtml += `
                            <div class="property-item">
                                <span class="property-key">${key}:</span>
                                <span class="property-value">${value}</span>
                            </div>
                        `;
                    });
                    propertiesHtml += '</div>';
                }

                html += `
                    <div class="material-item">
                        <div class="material-header">
                            <div class="material-name">${material.name}</div>
                            <div class="material-status ${statusClass}">${material.status}</div>
                        </div>
                        
                        <div class="material-details">
                            <div class="detail-item">
                                <div class="detail-label">Categoria</div>
                                <div class="detail-value">${material.category || 'N/D'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Unit√† di Misura</div>
                                <div class="detail-value">${material.unit_of_measure}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Prezzo Default</div>
                                <div class="detail-value">${price}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Creato</div>
                                <div class="detail-value">${new Date(material.created_at).toLocaleDateString('it-IT')}</div>
                            </div>
                        </div>

                        ${material.description ? `<p style="margin: 10px 0; color: #6c757d;"><strong>Descrizione:</strong> ${material.description}</p>` : ''}
                        
                        ${propertiesHtml}

                        <div class="material-actions">
                            <button onclick="editMaterialType(${material.id})" class="warning">‚úèÔ∏è Modifica</button>
                            <button onclick="deleteMaterialType(${material.id})" class="danger">üóëÔ∏è Elimina</button>
                            <button onclick="viewMaterialTypeDetails(${material.id})">üëÅÔ∏è Dettagli</button>
                        </div>
                    </div>
                `;
            });

            // Paginazione
            if (pagination && pagination.last_page > 1) {
                html += '<div style="text-align: center; margin-top: 20px;">';
                
                if (pagination.current_page > 1) {
                    html += `<button onclick="getMaterialTypes(${pagination.current_page - 1})">‚Üê Precedente</button>`;
                }
                
                html += `<span style="margin: 0 15px;">Pagina ${pagination.current_page} di ${pagination.last_page} (${pagination.total} totali)</span>`;
                
                if (pagination.current_page < pagination.last_page) {
                    html += `<button onclick="getMaterialTypes(${pagination.current_page + 1})">Successiva ‚Üí</button>`;
                }
                
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterUnit').value = '';
            document.getElementById('searchTerm').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('sortBy').value = 'created_at';
            document.getElementById('sortDirection').value = 'desc';
            document.getElementById('perPage').value = '15';
            getMaterialTypes();
        }

        // CRUD Operations
        async function saveMaterialType() {
            if (!authToken) {
                showResponse('formResponse', { error: 'Devi essere autenticato' }, true);
                return;
            }

            const id = document.getElementById('materialTypeId').value;
            const isEdit = !!id;

            const formData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                unit_of_measure: document.getElementById('unitOfMeasure').value,
                default_price: document.getElementById('defaultPrice').value || null,
                category: document.getElementById('category').value || null,
                status: document.getElementById('status').value
            };

            // Parse properties JSON
            const propertiesText = document.getElementById('properties').value.trim();
            if (propertiesText) {
                try {
                    formData.properties = JSON.parse(propertiesText);
                } catch (e) {
                    showResponse('formResponse', { error: 'Formato JSON non valido per le propriet√†' }, true);
                    return;
                }
            }

            try {
                const url = isEdit ? `${API_BASE}/material-types/${id}` : `${API_BASE}/material-types`;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showResponse('formResponse', data);
                    resetForm();
                    getMaterialTypes(); // Ricarica la lista
                } else {
                    showResponse('formResponse', data, true);
                }
            } catch (error) {
                showResponse('formResponse', { error: error.message }, true);
            }
        }

        async function editMaterialType(id) {
            if (!authToken) {
                alert('Devi essere autenticato');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/material-types/${id}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    const material = data.data;
                    
                    document.getElementById('materialTypeId').value = material.id;
                    document.getElementById('name').value = material.name;
                    document.getElementById('description').value = material.description || '';
                    document.getElementById('unitOfMeasure').value = material.unit_of_measure;
                    document.getElementById('defaultPrice').value = material.default_price || '';
                    document.getElementById('category').value = material.category || '';
                    document.getElementById('status').value = material.status;
                    
                    if (material.properties) {
                        document.getElementById('properties').value = JSON.stringify(material.properties, null, 2);
                    }
                    
                    document.getElementById('formTitle').textContent = '‚úèÔ∏è Modifica Material Type';
                    
                    // Scroll to form
                    document.getElementById('materialTypeForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Errore nel caricamento del material type');
                }
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        async function deleteMaterialType(id) {
            if (!authToken) {
                alert('Devi essere autenticato');
                return;
            }

            if (!confirm('Sei sicuro di voler eliminare questo material type?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/material-types/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Material type eliminato con successo');
                    getMaterialTypes(); // Ricarica la lista
                } else {
                    alert('Errore nell\'eliminazione: ' + (data.message || 'Errore sconosciuto'));
                }
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        async function viewMaterialType() {
            const id = document.getElementById('viewId').value;
            
            if (!id) {
                showResponse('viewResponse', { error: 'Inserisci un ID valido' }, true);
                return;
            }

            if (!authToken) {
                showResponse('viewResponse', { error: 'Devi essere autenticato' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/material-types/${id}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                showResponse('viewResponse', data, !data.success);
            } catch (error) {
                showResponse('viewResponse', { error: error.message }, true);
            }
        }

        function viewMaterialTypeDetails(id) {
            document.getElementById('viewId').value = id;
            viewMaterialType();
        }

        function resetForm() {
            document.getElementById('materialTypeForm').reset();
            document.getElementById('materialTypeId').value = '';
            document.getElementById('formTitle').textContent = '‚ûï Crea Nuovo Material Type';
            hideResponse('formResponse');
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                getMaterialTypes();
                getCategories();
                getUnitsOfMeasure();
            }
        });
    </script>
</body>
</html>